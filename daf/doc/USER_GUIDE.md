# DAF User Guide: Working with Real Metta Methods

## Overview

This guide explains how to use the DAF fork to work effectively with real Metta methods, understand the documentation system, and leverage the comprehensive tooling for multi-agent RL development.

## Understanding DAF's Role

### DAF is Not An Agent Framework
Remember the recursive acronym: **"DAF Is Not An Agent Framework"**

DAF enhances Metta's agent framework capabilities without replacing them:
- ✅ **Uses Real Metta Components**: All 51 validated methods are actual Metta functionality
- ✅ **Provides Documentation**: 1466 documented items with enhanced signatures
- ✅ **Offers Tooling**: Production-ready infrastructure around Metta
- ✅ **Validates Functionality**: Comprehensive testing of real Metta usage

### The Documentation Ecosystem

#### Two Documentation Locations:
1. **`@daf/`**: Autogenerated documentation from Metta methods (129 files)
2. **`daf/doc/`**: DAF-specific documentation explaining how everything works

#### Generated Documentation (`@daf/`)
```
@daf/methods/                           # 129 documentation files
├── adaptive_adaptive_controller.md     # Real AdaptiveController docs
├── cogworks_curriculum_curriculum.md   # Real Curriculum docs
├── rl_trainer.md                       # Real RL Trainer docs
├── setup_metta_cli.md                 # Real CLI docs
└── ... (125 more files)
```

## Working with Real Metta Methods

### 1. Finding Documentation

#### Browse Available Methods
```bash
# List all available method documentation
ls @daf/methods/

# Find specific functionality
cat @daf/methods/rl_trainer.md
cat @daf/methods/adaptive_adaptive_controller.md
```

#### Search for Specific Patterns
```bash
# Search for training-related methods
grep "def train" @daf/methods/rl_*.md

# Search for adaptive learning methods
grep "AdaptiveController" @daf/methods/adaptive_*.md

# Search for configuration methods
grep "Config" @daf/methods/setup_*.md
```

### 2. Understanding Method Signatures

#### Enhanced Type Information
```python
# From @daf/methods/adaptive_adaptive_controller.md
def run(self, on_training_completed: Optional[Callable] = ..., on_eval_completed: Optional[Callable] = ..., on_job_dispatch: Optional[Callable] = ...) -> Any
```

#### Real Usage Examples
```python
# Real AdaptiveController usage
from metta.adaptive.adaptive_controller import AdaptiveController
from metta.adaptive.stores.wandb import WandbStore

controller = AdaptiveController(
    experiment_id="my_experiment",
    store=WandbStore(project="my-project"),
    config=AdaptiveConfig()
)

# Real training execution
results = controller.run()
```

### 3. Using Real Metta Components

#### Adaptive Learning
```python
# Real adaptive controller setup
from metta.adaptive.adaptive_controller import AdaptiveController
from metta.adaptive.stores.wandb import WandbStore
from metta.adaptive.dispatcher.local import LocalDispatcher

# Real component configuration
config = AdaptiveConfig()
store = WandbStore(project="my-experiment")
dispatcher = LocalDispatcher()

# Real controller instantiation
controller = AdaptiveController(
    experiment_id="adaptive_training",
    config=config,
    store=store,
    dispatcher=dispatcher
)

# Real experiment execution
results = controller.run()
```

#### Curriculum Learning
```python
# Real curriculum setup
from metta.cogworks.curriculum.curriculum import Curriculum
from metta.cogworks.curriculum.task_generator import SingleTaskGenerator

# Real curriculum creation
curriculum = Curriculum(config=CurriculumConfig())
curriculum.add_task("navigation", difficulty=0.3)
curriculum.add_task("manipulation", difficulty=0.7)

# Real task generation
task_gen = SingleTaskGenerator(TaskGeneratorConfig())
task = task_gen.get_task(difficulty=0.5)

# Real learning progress
curriculum.update_task_performance("navigation", 0.8)
stats = curriculum.stats()
```

#### RL Training
```python
# Real RL trainer setup
from metta.rl.trainer import Trainer as MettaTrainer
from metta.rl.trainer_config import TrainerConfig
from metta.rl.checkpoint_manager import CheckpointManager

# Real trainer configuration
trainer_config = TrainerConfig(
    total_timesteps=100000,
    batch_size=2048,
    learning_rate=3e-4
)

# Real trainer instantiation
trainer = MettaTrainer(
    cfg=trainer_config,
    env=RealEnvironment(),
    policy=RealPolicy(),
    device="cpu"
)

# Real training execution
results = trainer.train()

# Real checkpointing
checkpoint_manager = CheckpointManager(run="my_training")
checkpoint_uri = checkpoint_manager.save_agent(trainer.policy, epoch=100)
```

## DAF Tooling and Enhancements

### 1. Configuration Management

#### Environment-Specific Configuration
```python
from daf.config.daf_config import DAFConfigManager, create_development_config

# Development configuration
config_manager = create_development_config("my_experiment")
config = config_manager.get_config()

# Production configuration
prod_config_manager = create_production_config("prod_experiment")
prod_config = prod_config_manager.get_config()
```

#### Real Metta Integration
```python
# Real Metta CLI integration
from metta.setup.metta_cli import MettaCLI
from metta.setup.saved_settings import SavedSettings

metta_cli = MettaCLI()
saved_settings = SavedSettings.get_saved_settings()

# Real component configuration
config_manager.configure_component("wandb", {"project": "my-project"})
config_manager.configure_component("aws", {"region": "us-west-2"})
```

### 2. Enhanced Logging and Monitoring

#### Structured Logging
```python
from daf.logging import setup_daf_logging, LogManager, DAFLogger

# Real logging setup
setup_daf_logging(
    log_level="INFO",
    log_file="training.log",
    console_output=True
)

# Real structured logging
logger = DAFLogger("training", {"experiment": "test"})
logger.info("Training started", {"episodes": 1000, "lr": 0.001})
```

#### Comprehensive Monitoring
```python
# Real monitoring setup
log_manager = LogManager("logs")
training_logger = log_manager.setup_component_logging("training", "INFO")

# Real metrics collection
def monitor_training_progress(results):
    log_manager.log_metrics({
        "episode_reward": results["avg_reward"],
        "episode_length": results["avg_length"],
        "policy_loss": results["policy_loss"]
    })
```

### 3. Curriculum Learning with DAF

#### Enhanced Curriculum Management
```python
from daf.core.curriculum_manager import DAFCurriculumManager, DAFCurriculumConfig

# Real curriculum with DAF enhancements
config = DAFCurriculumConfig(
    name="progressive_curriculum",
    enable_learning_progress=True,
    enable_slice_analysis=True
)

curriculum_manager = DAFCurriculumManager(config)

# Real task progression
curriculum_manager.add_task("navigation", difficulty=0.2)
curriculum_manager.add_task("manipulation", difficulty=0.5)
curriculum_manager.add_task("cooperation", difficulty=0.8)

# Real adaptive task selection
next_task = curriculum_manager.get_next_task()
performance = train_on_task(next_task)
curriculum_manager.update_task_performance(next_task, performance)

# Real curriculum adaptation
if performance > 0.8:
    curriculum_manager._check_curriculum_adaptation(next_task, performance)
```

#### Progressive Training Scenarios
```python
# Real progressive training setup
scenarios = curriculum_manager.generate_task_sequence(
    sequence_length=10,
    difficulty_progression="adaptive"
)

for task_id in scenarios:
    # Real task configuration
    task_info = curriculum_manager._custom_tasks[task_id]

    # Real environment setup
    env = create_environment_for_task(task_id, task_info["difficulty"])

    # Real training execution
    results = train_on_task(task_id, env)

    # Real performance tracking
    curriculum_manager.update_task_performance(task_id, results["avg_reward"])

    # Real curriculum statistics
    stats = curriculum_manager.get_curriculum_stats()
```

### 4. RL Training with DAF Enhancements

#### Adaptive Training Integration
```python
from daf.core.rl_trainer import DAFRlTrainer, DAFRlConfig
from daf.core.adaptive_controller import DAFAdaptiveController, DAFAdaptiveConfig

# Real RL trainer with adaptive integration
trainer_config = DAFRlConfig(
    experiment_name="adaptive_training",
    total_timesteps=100000,
    integrate_with_adaptive=True
)

# Real adaptive controller integration
adaptive_config = DAFAdaptiveConfig(
    experiment_id="adaptive_experiment",
    enable_curriculum_learning=True
)

adaptive_controller = DAFAdaptiveController(adaptive_config)

# Real enhanced trainer
trainer = DAFRlTrainer(
    config=trainer_config,
    policy=create_policy(),
    adaptive_controller=adaptive_controller
)

# Real training with adaptive feedback
results = trainer.train()
```

#### Curriculum-Driven Training
```python
# Real curriculum-driven training
curriculum_manager = DAFCurriculumManager()
trainer = DAFRlTrainer(config=DAFRlConfig(), policy=policy)

# Real task sequence generation
task_sequence = curriculum_manager.generate_task_sequence(
    sequence_length=15,
    difficulty_progression="adaptive"
)

for task_id in task_sequence:
    # Real task configuration
    task_config = curriculum_manager._custom_tasks[task_id]["config"]

    # Real environment setup
    env = create_environment_from_config(task_config)

    # Real training execution
    training_results = trainer.train_on_task(task_id, env, episodes=50)

    # Real performance feedback
    performance = training_results["avg_reward"]
    curriculum_manager.update_task_performance(task_id, performance)

# Real curriculum statistics
final_stats = curriculum_manager.get_curriculum_stats()
```

## Real-World Usage Patterns

### 1. Production Training Pipeline

#### Complete Production Setup
```python
def setup_production_training():
    """Set up complete production training pipeline"""

    # Real configuration management
    config_manager = DAFConfigManager()
    config_manager.setup_environment("production")

    # Real adaptive controller
    adaptive_config = DAFAdaptiveConfig(
        experiment_id="production_training",
        use_skypilot=True,
        wandb_project="production-experiments"
    )
    adaptive_controller = DAFAdaptiveController(adaptive_config)

    # Real curriculum
    curriculum_config = DAFCurriculumConfig(
        max_active_tasks=20,
        enable_learning_progress=True,
        enable_slice_analysis=True
    )
    curriculum_manager = DAFCurriculumManager(curriculum_config)

    # Real RL trainer
    trainer_config = DAFRlConfig(
        experiment_name="production_training",
        total_timesteps=1000000,
        integrate_with_adaptive=True,
        curriculum_config=curriculum_config
    )

    trainer = DAFRlTrainer(
        config=trainer_config,
        policy=create_production_policy(),
        adaptive_controller=adaptive_controller,
        curriculum_manager=curriculum_manager
    )

    return adaptive_controller, curriculum_manager, trainer
```

#### Production Training Execution
```python
def run_production_training():
    """Execute production training with real components"""

    adaptive_controller, curriculum_manager, trainer = setup_production_training()

    # Real training with monitoring
    def training_complete_callback(results):
        # Real WandB logging
        adaptive_controller._store.log_metrics(results)

        # Real curriculum update
        for task_id, performance in results["task_performance"].items():
            curriculum_manager.update_task_performance(task_id, performance)

    # Real training execution
    results = trainer.train(on_training_complete=training_complete_callback)

    # Real final evaluation
    final_results = {
        "training_results": results,
        "curriculum_stats": curriculum_manager.get_curriculum_stats(),
        "adaptive_status": adaptive_controller.get_experiment_status()
    }

    return final_results
```

### 2. Experiment Management

#### Real Experiment Tracking
```python
def manage_real_experiments():
    """Manage real experiments with DAF tooling"""

    # Real experiment configuration
    experiments = [
        {"name": "baseline", "curriculum": "simple", "training": "standard"},
        {"name": "adaptive", "curriculum": "progressive", "training": "adaptive"},
        {"name": "curriculum_only", "curriculum": "complex", "training": "standard"}
    ]

    results = {}

    for exp_config in experiments:
        # Real component setup
        adaptive_controller = DAFAdaptiveController(
            config=DAFAdaptiveConfig(experiment_id=exp_config["name"])
        )

        curriculum_manager = DAFCurriculumManager(
            config=DAFCurriculumConfig(name=exp_config["curriculum"])
        )

        trainer = DAFRlTrainer(
            config=DAFRlConfig(experiment_name=exp_config["name"]),
            policy=create_policy(),
            adaptive_controller=adaptive_controller,
            curriculum_manager=curriculum_manager
        )

        # Real experiment execution
        exp_results = trainer.train()

        # Real results tracking
        results[exp_config["name"]] = {
            "results": exp_results,
            "curriculum_stats": curriculum_manager.get_curriculum_stats(),
            "adaptive_status": adaptive_controller.get_experiment_status()
        }

    return results
```

### 3. Error Handling and Recovery

#### Real Error Scenarios
```python
def handle_real_production_errors():
    """Handle real errors in production environment"""

    try:
        # Real adaptive controller
        controller = DAFAdaptiveController(
            config=DAFAdaptiveConfig(experiment_id="production")
        )

        # Real training execution
        results = controller.run()

    except WandbConnectionError:
        # Real fallback to local storage
        controller = DAFAdaptiveController(
            config=DAFAdaptiveConfig(experiment_id="production", use_wandb=False),
            store=LocalStore()
        )
        results = controller.run()

    except TrainingEnvironmentError:
        # Real environment recovery
        alternative_env = create_alternative_environment()
        results = controller.run_with_environment(alternative_env)

    except CurriculumStagnationError:
        # Real curriculum adaptation
        curriculum_manager = DAFCurriculumManager()
        curriculum_manager.adapt_curriculum("reduce_difficulty")
        results = controller.run()

    return results
```

## Best Practices

### 1. Documentation-First Development
```python
# Always check documentation first
cat @daf/methods/adaptive_adaptive_controller.md
cat @daf/methods/cogworks_curriculum_curriculum.md

# Use real method signatures
controller = AdaptiveController(
    experiment_id="my_experiment",
    config=AdaptiveConfig(),
    store=WandbStore(project="my-project")
)
```

### 2. Configuration Management
```python
# Use environment-specific configurations
config_manager = create_development_config("dev_experiment")
config_manager = create_production_config("prod_experiment")

# Real Metta CLI integration
metta_cli = MettaCLI()
saved_settings = SavedSettings.get_saved_settings()
```

### 3. Comprehensive Testing
```python
# Test with real components
python -m pytest tests/unit/test_real_metta_usage.py -v
python -m pytest tests/integration/ -v

# Verify real functionality
python daf/validate_metta_usage.py
python daf/simple_validation.py
```

### 4. Production Deployment
```python
# Use production configurations
config_manager = DAFConfigManager()
config_manager.setup_environment("production")

# Real monitoring and logging
log_manager = LogManager("production_logs")
setup_daf_logging(log_level="INFO", log_file="production.log")

# Real component initialization
adaptive_controller = DAFAdaptiveController(production_config)
```

This user guide demonstrates how to effectively use the DAF fork to work with real Metta methods, leveraging the comprehensive documentation, tooling, and validation systems provided by the DAF ecosystem.
